# Create the schema including JSON Duality Views

## Introduction

This lab walks you through the setup steps to create the user, tables, and JSON duality views needed to execute the rest of this workshop. Then you will populate the views and tables.

Estimated Time: 20 minutes

### Objectives

In this lab, you will:
* Login as your database user
* Create the JSON Duality Views and base tables needed
* Populate your database

### Prerequisites

This lab assumes you have:
* Access to OCI console
* Oracle Autonomous Database 23ai Free Tier instance

## Task 1: Preparing your database user

1. Your browser should be open at the Oracle LiveLabs My Reservations page. When your LiveLabs environment is ready, click **Launch Workshop**.
    
    ![Image alt text](images/launch-workshop.png " ")

2. Click **View Login Info**.

    ![Image alt text](images/login-info.png " ")

3. Click **Copy Password** and then **Launch OCI**. Verify that the password was correctly copied, if not, manually copy it.

    ![Image alt text](images/reservation-info.png " ")

4. Use **Oracle Cloud Infrastructure Direct Sign-in** to paste the password you copied. When you log-in for the first time, it will ask you to update the password. Write down in your notes the new password.

    ![Image alt text](images/oci-sing-in.png " ")

5. Use the main menu **â‰¡** to navigate to Oracle Database > **Autonomous Database**.

    ![Image alt text](images/main-menu.png " ")

6. Select your reservation **Compartment** on the left side drop-down, and click on your Autonomous Database instance name under Display name.

    ![Image alt text](images/adb-instance.png " ")

7. You will be within the Autonomous Database details. Feel free to amiliarize yourself with the OCI console for Autonomous Database and what we have to offer.

    ![Image alt text](images/adb-console.png " ")

8. Open Database actions, and select Database Users in the menu to open the **Database Users** console.

    ![Image alt text](images/database-actions.png " ")

9. Once the landing page loads, Click **Create User**.

    ![Image alt text](images/database-users.png " ")

    This will be the what will populate. 

    ![Image alt text](images/create-user-0.png " ")

10. Create a new user called **hol23ai** (case insensitive). You may use the same password from admin user you received on Reservation Information dialog at step #3. Next, Enable **Web Access** on the bottom on the screen. Finally, set Quota on Table **UNLIMITED** quota on tablespace DATA.

    ![Image alt text](images/create-user.png " ")

11. Click **Granted Roles**. Type ords in the **Filter by role**. Add ORDS_ADMINISTRATOR_ROLE, ORDS_RUNTIME_ROLE as Granted and Default.

    ![Image alt text](images/granted-roles.png " ")

12. In the same **Filter by role**, search for dwrole. Add DWROLE as Granted and Default. Click **Create User**.
    ![Image alt text](images/dwrole.png " ")

13. Verify the Granted Roles should reflect 5, once done click **Create User**.
    ![Image alt text](images/create-user-done.png " ")


14. The new hol23ai user card will appear in the list. You can copy the SQL Developer URL in your notes.

    ![Image alt text](images/hol23ai-user.png " ")

15. On the upper right hand of the console, Click the ADMIN user menu, and **Sign Out**.

    ![Image alt text](images/sign-out.png " ")

16. Sing-in with the new user **hol23ai**.

    ![Image alt text](images/hol23ai-sign-in.png " ")

17. Once logged in, click SQL worksheet. This is where our work will be perfomed. Click **SQL** worksheet button under Development. If you are to sign out, you can go back to this section by clicking on **Development**.

    ![Image alt text](images/development-sql.png " ")


## Task 2: Creating your database tables and JSON duality views

1. Upon accessing the SQL for the first time, you'll be given a quick Tour of the console. This will explain what the different sections and icons in the console are used for. Feel free to hit Next and read the description or just hit the X to close the Tour. 

    ![Image alt text](images/tour.png " ")

2. As you go through this workshop, we will specify on where to use the click the Run button or Run Script button to run our statements. The Run button runs just one SQL Statement and formats the output into a data grid. The Run Script button runs many SQL statements and spools their output. We will highlight which to use.

    ![Image alt text](images/run-sql-script.png " ")

3. You will need to create your tables. Copy the code below and run it in the worksheet by clicking the **Run Script** button.



    ```
    <copy>

    DROP VIEW IF EXISTS team_dv;
    DROP VIEW IF EXISTS race_dv;
    DROP VIEW IF EXISTS driver_dv;
    DROP TABLE IF EXISTS driver_race_map;
    DROP TABLE IF EXISTS race;
    DROP TABLE IF EXISTS driver;
    DROP TABLE IF EXISTS team;

    CREATE TABLE IF NOT EXISTS team
    (team_id INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    name    VARCHAR2(255) NOT NULL UNIQUE,
    points  INTEGER NOT NULL,
    CONSTRAINT team_pk PRIMARY KEY(team_id));

    CREATE TABLE IF NOT EXISTS driver
    (driver_id INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    name      VARCHAR2(255) NOT NULL UNIQUE,
    points    INTEGER NOT NULL,
    team_id   INTEGER,
    CONSTRAINT driver_pk PRIMARY KEY(driver_id),
    CONSTRAINT driver_fk FOREIGN KEY(team_id) REFERENCES team(team_id));

    CREATE TABLE IF NOT EXISTS race
    (race_id   INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    name      VARCHAR2(255) NOT NULL UNIQUE,
    laps      INTEGER NOT NULL,
    race_date DATE,
    podium  JSON,
    CONSTRAINT   race_pk PRIMARY KEY(race_id));

    CREATE TABLE IF NOT EXISTS driver_race_map
    (driver_race_map_id INTEGER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    race_id            INTEGER NOT NULL,
    driver_id          INTEGER NOT NULL,
    position           INTEGER,
    CONSTRAINT driver_race_map_pk  PRIMARY KEY(driver_race_map_id),
    CONSTRAINT driver_race_map_fk1 FOREIGN KEY(race_id) REFERENCES race(race_id),
    CONSTRAINT driver_race_map_fk2 FOREIGN KEY(driver_id) REFERENCES driver(driver_id));

    </copy>
    ```

    ![Image alt text](images/create-tables.png " ")

4. We will now create a trigger on the driver\_race\_map table to populate the points fields in team and driver based on race results. You can either click the trash to clear the worksheet or delete what is there before pasting the code below.Once you've pasted the code into the Worksheet, Click **Run Script**.

    ```
    <copy>

    CREATE OR REPLACE TRIGGER driver_race_map_trigger
    BEFORE INSERT ON driver_race_map
    FOR EACH ROW
    DECLARE
        v_points  INTEGER;
        v_team_id INTEGER;
    BEGIN
    SELECT team_id INTO v_team_id FROM driver WHERE driver_id = :NEW.driver_id;
    IF :NEW.position = 1 THEN
        v_points := 25;
    ELSIF :NEW.position = 2 THEN
        v_points := 18;
    ELSIF :NEW.position = 3 THEN
        v_points := 15;
    ELSIF :NEW.position = 4 THEN
        v_points := 12;
    ELSIF :NEW.position = 5 THEN
        v_points := 10;
    ELSIF :NEW.position = 6 THEN
        v_points := 8;
    ELSIF :NEW.position = 7 THEN
        v_points := 6;
    ELSIF :NEW.position = 8 THEN
        v_points := 4;
    ELSIF :NEW.position = 9 THEN
        v_points := 2;
    ELSIF :NEW.position = 10 THEN
        v_points := 1;
    ELSE
        v_points := 0;
    END IF;
    UPDATE driver SET points = points + v_points
        WHERE driver_id = :NEW.driver_id;
    UPDATE team SET points = points + v_points
        WHERE team_id = v_team_id;
    END;
    /

    </copy>
    ```

    ![Image alt text](images/create-trigger.png " ")

5. Now we will create the RACE\_DV duality view. Notice that we only allow updates on the driver table but insert update delete onto race and driver\_race\_map. You have the ability to control the interaction at the table level within your view. In the next step you will create a duality view to create and delete drivers. You can either click the trash to clear the worksheet or delete what is there before pasting the code below. Once pasted, Click **Run Script**.

    ```
    <copy>
    CREATE OR REPLACE JSON RELATIONAL DUALITY VIEW race_dv AS
    SELECT JSON {
                '_id' IS r.race_id,
                'name'   IS r.name,
                'laps'   IS r.laps WITH NOUPDATE,
                'date'   IS r.race_date,
                'podium' IS r.podium WITH NOCHECK,
                'result' IS
                    [ SELECT JSON {'driverRaceMapId' IS drm.driver_race_map_id,
                                    'position'        IS drm.position,
                                    UNNEST
                                    (SELECT JSON {'driverId' IS d.driver_id,
                                                    'name'     IS d.name}
                                        FROM driver d WITH NOINSERT UPDATE NODELETE
                                        WHERE d.driver_id = drm.driver_id)}
                        FROM driver_race_map drm WITH INSERT UPDATE DELETE
                        WHERE drm.race_id = r.race_id ]}
        FROM race r WITH INSERT UPDATE DELETE;
		</copy>
    ```

	![Image alt text](images/create-race-dv.png " ")

6. Now we will create the DRIVER\_DV duality view. Since this is for drivers, we don't want them creating teams or races so we shall set those to NOINSERT, NOUPDATE, NODELETE. They can also update or insert a driver's race map but not remove them. You can either click the trash to clear the worksheet or delete what is there before pasting the code below. Click **Run Script**.

	```
	<copy>
    CREATE OR REPLACE JSON RELATIONAL DUALITY VIEW driver_dv AS
    SELECT JSON {'_id' IS d.driver_id,
            'name'     IS d.name,
            'points'   IS d.points,
            UNNEST
                (SELECT JSON {'teamId' IS t.team_id,
                            'team'   IS t.name WITH NOCHECK}
                    FROM team t WITH NOINSERT NOUPDATE NODELETE
                    WHERE t.team_id = d.team_id),
            'race'     IS
                [ SELECT JSON {'driverRaceMapId' IS drm.driver_race_map_id,
                                UNNEST
                                (SELECT JSON {'raceId' IS r.race_id,
                                                'name'   IS r.name}
                                    FROM race r WITH NOINSERT NOUPDATE NODELETE
                                    WHERE r.race_id = drm.race_id),
                                'finalPosition'   IS drm.position}
                    FROM driver_race_map drm WITH INSERT UPDATE NODELETE
                    WHERE drm.driver_id = d.driver_id ]}
    FROM driver d WITH INSERT UPDATE DELETE;
	</copy>
    ```
    ![Image alt text](images/create-driver-dv.png " ")

7. The last duality view is TEAMS\_DV. When creating or modifying a team you can insert or update a driver. You can either click the trash to clear the worksheet or delete what is there before pasting the code below. Click **Run Script**.

	```
	<copy>  
    CREATE OR REPLACE JSON RELATIONAL DUALITY VIEW team_dv AS
    SELECT JSON {'_id'  IS t.team_id,
                'name'    IS t.name,
                'points'  IS t.points,
                'driver'  IS
                    [ SELECT JSON {'driverId' IS d.driver_id,
                                    'name'     IS d.name,
                                    'points'   IS d.points WITH NOCHECK}
                        FROM driver d WITH INSERT UPDATE
                        WHERE d.team_id = t.team_id ]}
        FROM team t WITH INSERT UPDATE DELETE;

    </copy>
    ```
	![Image alt text](images/create-team-dv.png " ")

## Task 3: Populating the database
1. We are now inserting a collection of team documents into TEAM\_DV. This automatically populates the driver and team table as well as the driver collection. If you remember, the team duality view joins team and driver. It also allows inserts into both tables. Copy the sql below and click **Run Script**

    ```
    <copy>
    INSERT INTO team_dv VALUES ('{"_id" : 301,
                            "name"   : "Red Bull",
                            "points" : 0,
                            "driver" : [ {"driverId" : 101,
                                            "name"     : "Max Verstappen",
                                            "points"   : 0},
                                        {"driverId" : 102,
                                            "name"     : "Sergio Perez",
                                            "points"   : 0} ]}');

    INSERT INTO team_dv VALUES ('{"_id" : 302,
                                "name"   : "Ferrari",
                                "points" : 0,
                                "driver" : [ {"driverId" : 103,
                                                "name"     : "Charles Leclerc",
                                                "points"   : 0},
                                            {"driverId" : 104,
                                                "name"     : "Carlos Sainz Jr",
                                                "points"   : 0} ]}');

    INSERT INTO team_dv VALUES ('{"_id" : 2,
                                "name"   : "Mercedes",
                                "points" : 0,
                                "driver" : [ {"driverId" : 105,
                                                "name"     : "George Russell",
                                                "points"   : 0},
                                            {"driverId" : 106,
                                                "name"     : "Lewis Hamilton",
                                                "points"   : 0} ]}');
    COMMIT;
	</copy>
	```
	![Image alt text](images/insert-team-dv.png " ")

2. Additionally, we are now inserting a collection of race documents into RACE\_DV. This automatically populates the race table. You can either click the trash to clear the worksheet or delete what is there before pasting the code below. Copy the sql below and click **Run Script** 

	```
    <copy>
    INSERT INTO race_dv VALUES ('{"_id" : 201,
                                "name"   : "Bahrain Grand Prix",
                                "laps"   : 57,
                                "date"   : "2022-03-20T00:00:00",
                                "podium" : {}}');

    INSERT INTO race_dv VALUES ('{"_id" : 202,
                                "name"   : "Saudi Arabian Grand Prix",
                                "laps"   : 50,
                                "date"   : "2022-03-27T00:00:00",
                                "podium" : {}}');

    INSERT INTO race_dv VALUES ('{"_id" : 203,
                                "name"   : "Australian Grand Prix",
                                "laps"   : 58,
                                "date"   : "2022-04-09T00:00:00",
                                "podium" : {}}');
    COMMIT;
    </copy>
    ```

	![Image alt text](images/insert-race-dv.png " ")

3. Populating a duality view automatically updates data shown in related duality views, by updating their underlying tables.

    For example, in the previous step, documents were inserted into the team\_dv duality view. This duality view joins the team table with the driver table. Once we insert into this duality view, both the team table as well as the driver table are populated.

    If you now list the contents of the driver\_dv duality view, which is based on the driver table, it has documents as well. You can either click the trash to clear the worksheet or delete what is there before pasting the code below. Copy the sql below and click **Run Script** 

    ```
    <copy>
    SELECT json_serialize(data PRETTY) FROM driver_dv;
    SELECT json_serialize(data PRETTY) FROM race_dv;
    </copy>
    ```

    ![Image alt text](images/print-driver-race.png " ")

    Your setup is now complete.

You may **proceed to the next lab.** 

## Learn More

* [JSON Relational Duality: The Revolutionary Convergence of Document, Object, and Relational Models](https://blogs.oracle.com/database/post/json-relational-duality-app-dev)
* [JSON Duality View documentation](http://docs.oracle.com)
* [Blog: Key benefits of JSON Relational Duality](https://blogs.oracle.com/database/post/key-benefits-of-json-relational-duality-experience-it-today-using-oracle-database-23c-free-developer-release)

## Acknowledgements
* **Author** - Valentin Tabacaru, Kaylien Phan, William Masdon
* **Contributors** - David Start, Ranjan Priyadarshi
* **Last Updated By/Date** - Francis Regalado, Database Product Management, July 2024
