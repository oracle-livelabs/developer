# Full Stack Application with OpenStreetMap and Spatial Queries to Locate Hospitals

## Introduction

This workshop walks you through the steps of locating Hospitals based on location and patient trauma.

Estimated Time: 10 minutes.  
 
### Objectives

In this lab, you will:
 
* Create the required schema
* Update SDO_GEOMETRY Column
* Run the full stack applicatoin and visual the location of hospitals on a map
  
### Prerequisites

- Completion of Setup lab

### About Spatial Geometry Objects

Spatial geometry objects are drawn on the background map based on data in a table. That table can be sourced from local table or a SQL query. Maps created using the Create Page Wizard or in Page Designer, support both local database tables, REST Enabled SQL, and from REST Data Sources. Maps support a rich set of built-in marker icons and shapes. Supported spatial geometry objects include:
* Points - Points (for example, customer or supplier locations) display as markers.
* Lines - Lines represent features like roads or paths.
* Polygons - Polygons represent areas like parcels, states or countries.
* Heat Map - Heat Maps are used to visualize the point density. The more points that are clustered together, the more intense the color becomes. Use this option to visualize the spatial distribution of population or incidents.
* Extruded Polygons - Display as three-dimensional, extruded, objects. The height of the 3D object visualizes a column value.

You can source spatial geometry objects from either:

* Geometry Column - Supported datatypes include SDO_GEOMETRY, VARCHAR2, or CLOB. VARCHAR2 and CLOB columns must contain geometry information in GeoJSON format.
Two Numeric Columns - These columns must contain longitude and latitude values. This option only applies to Point and Heat Map objects.

### About Spatial Data
Oracle Database stores spatial data (points, lines, polygons) in a native data type called SDO_GEOMETRY. Oracle Database also provides a native spatial index for high performance spatial operations. This spatial index relies on spatial metadata that is entered for each table and geometry column storing spatial data. Once spatial data is populated and indexed, robust APIs are available to perform spatial analysis, calculations, and processing.

The SDO_GEOMETRY type has the following general format:

  ```sql
<copy>
    SDO_GEOMETRY( 
        [geometry type],           --ID for point/line/polygon
        [coordinate system],       --ID of coordinate system
        [point coordinate],        --for points only
        [line/polygon info],       --for lines/polygons only
        [line/polygon coordinates] --for lines/polygons only
    )
</copy>
```
  
## Task 1: Create the required schema

1. From **APEX workspace** select **SQL Workshop** and **SQL Commands** option.
 
    ![Create Table](images/apex-createtable.png " ")
  
    ```sql
    <copy>
    CREATE TABLE  "US_HOSPITALS" 
    (	
        "ID_1" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
        "LATITUDE" NUMBER, 
        "LONGITUDE" NUMBER, 
        "OBJECTID" NUMBER, 
        "ID" NUMBER, 
        "NAME" VARCHAR2(255) COLLATE "USING_NLS_COMP", 
        "ADDRESS" VARCHAR2(255) COLLATE "USING_NLS_COMP", 
        "CITY" VARCHAR2(50) COLLATE "USING_NLS_COMP", 
        "STATE" VARCHAR2(50) COLLATE "USING_NLS_COMP", 
        "ZIP" NUMBER, 
        "TELEPHONE" VARCHAR2(50) COLLATE "USING_NLS_COMP", 
        "TYPE" VARCHAR2(50) COLLATE "USING_NLS_COMP", 
        "STATUS" VARCHAR2(50) COLLATE "USING_NLS_COMP", 
        "POPULATION" NUMBER, 
        "COUNTY" VARCHAR2(50) COLLATE "USING_NLS_COMP", 
        "COUNTYFIPS" NUMBER, 
        "COUNTRY" VARCHAR2(50) COLLATE "USING_NLS_COMP",  
        "NAICS_CODE" NUMBER, 
        "NAICS_DESC" VARCHAR2(255) COLLATE "USING_NLS_COMP", 
        "SOURCE" VARCHAR2(255) COLLATE "USING_NLS_COMP", 
        "WEBSITE" VARCHAR2(255) COLLATE "USING_NLS_COMP", 
        "OWNER" VARCHAR2(255) COLLATE "USING_NLS_COMP", 
        "TTL_STAFF" NUMBER, 
        "BEDS" NUMBER, 
        "TRAUMA" VARCHAR2(50) COLLATE "USING_NLS_COMP", 
        "SHAPE" "SDO_GEOMETRY", 
        PRIMARY KEY ("ID_1")
    USING INDEX  ENABLE
    )  DEFAULT COLLATION "USING_NLS_COMP" 
    VARRAY "SHAPE"."SDO_ELEM_INFO" STORE AS SECUREFILE LOB 
    VARRAY "SHAPE"."SDO_ORDINATES" STORE AS SECUREFILE LOB
        
    </copy>
    ```

    > **Note** 1: For Hospital data you can google search for *us hospital dataset with latitude and longitude* and choose the dataset of your choice that contains the required table columns below. Other columns are optional

    * LATITUDE
    * LONGITUDE
    * NAME or HOSPITAL NAME
    * TRAUMA
    * STATE or CITY

## Task 2: Update SDO_GEOMETRY Column

1. The **Shape** column in the above table is of type **SDO_GEOMETRY** which can be generated by Latitude and Longitude data of a row by using update query. sample data of that column are.

    ```sql
    <copy>
        [Point (40.7283,-111.8780)]
    </copy>
    ```

    Where 40.7283 is LONGITUDE and -111.8779698 is LATITUDE

    ```sql
    <copy>
        update US_HOSPITALS
        set x = sdo_geometry( 2001,null,
                    sdo_point_type( LONGITUDE ,LATITUDE,null),
                    null,null )
        where LATITUDE is not null;
        commit;
    </copy>
    ```

## Task 3: Run the application

1. Open the frontend via your preferred method as was done in setup and select the `Hospitals` item from the sidebar menu.
   ![hospitals button](images/hospitals.png " ")


2. Notice the location of hospitals on the map.

   ![hospitals results](images/hospitalsresults.png " ")


## Task 2: Understand the code

1. Notice the `/flutter-frontend/lib/hospitals.dart` source code and how it creates a request to the Spring Boot backend and parses the JSON response into a resultant fields.


2. Notice the `/springboot-backend/src/main/java/oracleai/HealthDataController.java` source code and how it creates a request to the document model deployed in the OCI Vision service and passes the JSON response back to the frontend.

You may now **proceed to the next lab.**..

## Learn More

* [Spatial queries involving lattitude and longitude](https://asktom.oracle.com/pls/apex/f?p=100:11:::::P11_QUESTION_ID:9539156000346599825)
* [Oracle APEX Product homepage](https://apex.oracle.com/)
* [Oracle Spatial Product homepage](https://www.oracle.com/database/spatial)

## Acknowledgements

* **Author** - Paul Parkinson, Architect and Developer Advocate, Oracle Database
* **Author** - Madhusudhan Rao B M, Principal Product Manager, Oracle Database
* **Last Updated By/Date** - 2024